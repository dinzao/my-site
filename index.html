<!DOCTYPE html>  
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Audio Visualizer</title>
  <style>
    body {
      background-color: #1e1e1e;
      margin: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: sans-serif;
      color: white;
      cursor: none;
      overflow-x: hidden;
    }

    canvas {
      margin-bottom: 30px;
      background: transparent;
      transition: opacity 1s ease;
    }

    .play-button {
      background: linear-gradient(90deg, #00ffe7, #00b39f);
      border: none;
      border-radius: 999px;
      padding: 15px 30px;
      color: black;
      font-weight: bold;
      font-size: 16px;
      cursor: none !important;
      box-shadow: 0 0 10px #00fff2;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      transition: width 0.4s ease, background 0.3s ease, transform 0.2s ease;
      width: 140px;
    }

    .play-button.playing {
      width: 200px;
    }

    .play-button span {
      position: relative;
      z-index: 1;
      display: inline-block;
      transition: opacity 0.3s ease;
    }

    #seekSlider {
      width: 300px;
      -webkit-appearance: none;
      appearance: none;
      height: 5px;
      border-radius: 3px;
      background: #444;
      box-shadow: 0 0 5px #00fff2;
      outline: none;
      cursor: none !important;
      user-select: none;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    #seekSlider:hover {
      transform: scale(1.03);
      box-shadow: 0 0 8px #00fff2;
    }

    #seekSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #00fff2;
      border: none;
      cursor: none !important;
      box-shadow: 0 0 5px #00fff2;
    }

    #seekSlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #00fff2;
      border: none;
      cursor: none !important;
      box-shadow: 0 0 5px #00fff2;
    }

    #customCursor {
      position: fixed;
      width: 32px;
      height: 32px;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      transition: transform 0.15s ease, opacity 0.2s ease;
      border-radius: 6px;
      overflow: hidden;
      opacity: 0;
      background: linear-gradient(90deg, #ff0000, #ff9900, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
      background-size: 400% 400%;
      animation: rainbow 5s linear infinite;
      box-shadow: 0 0 15px #fff;
      animation: rainbow-border 5s linear infinite;
    }

    #customCursor video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #customCursor.visible {
      opacity: 1;
    }

    #customCursor.click {
      transform: translate(-50%, -50%) scale(0.8);
    }

    #customCursor.hover {
      transform: translate(-50%, -50%) scale(1.3);
    }

    a, button, input, .play-button {
      cursor: none !important;
    }

    @keyframes rainbow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes rainbow-border {
      0% { box-shadow: 0 0 15px #ff0000; }
      25% { box-shadow: 0 0 15px #00ff00; }
      50% { box-shadow: 0 0 15px #0000ff; }
      75% { box-shadow: 0 0 15px #ff00ff; }
      100% { box-shadow: 0 0 15px #ff0000; }
    }

    @media (hover: none), (pointer: coarse) {
      body {
        cursor: default !important;
      }
      #customCursor {
        display: none !important;
      }
      .play-button, #seekSlider {
        cursor: pointer !important;
      }
      #seekSlider {
        user-select: auto !important;
      }
      .play-button {
        width: 120px;
        padding: 12px 24px;
        font-size: 14px;
        margin-bottom: 15px;
      }
      #seekSlider {
        width: 260px;
      }
    }
  </style>
</head>
<body>

  <canvas id="visualizer" width="600" height="120" style="opacity: 0;"></canvas>
  <button class="play-button" id="playButton">
    <span id="buttonText">Play</span>
  </button>
  <input type="range" id="seekSlider" value="0" min="0" max="100" step="1" />
  <audio id="audio" src="JAWNY - honeypie sped up.mp3" crossorigin="anonymous" playsinline></audio>

  <div id="customCursor">
    <video id="cursorVideo" src="video_2025-07-31_22-33-25.mp4" autoplay muted loop playsinline></video>
  </div>

  <script>
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const playButton = document.getElementById('playButton');
    const buttonText = document.getElementById('buttonText');
    const audio = document.getElementById('audio');
    const seekSlider = document.getElementById('seekSlider');
    const customCursor = document.getElementById('customCursor');
    const cursorVideo = document.getElementById('cursorVideo');

    let audioContext, analyser, source, dataArray, animationId;
    let isInitialized = false;
    let isSeeking = false;
    let fadeOutProgress = 0;

    function draw() {
      const bufferLength = analyser.frequencyBinCount;
      const half = Math.floor(bufferLength / 2);
      const centerX = canvas.width / 2;
      const barSpacing = 4;
      const barWidth = (canvas.width / bufferLength) - barSpacing;

      function animate() {
        animationId = requestAnimationFrame(animate);
        analyser.getByteFrequencyData(dataArray);

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        let allZero = true;
        for (let i = 0; i < bufferLength; i++) {
          if (dataArray[i] > 0) { allZero = false; break; }
        }

        if (audio.paused && allZero) {
          fadeOutProgress = Math.max(0, fadeOutProgress - 0.05);
        } else {
          fadeOutProgress = Math.min(1, fadeOutProgress + 0.1);
        }

        ctx.globalAlpha = fadeOutProgress;
        ctx.strokeStyle = "#ffffff";

        for (let i = 0; i < half; i++) {
          const value = dataArray[i];
          const height = (value / 255) * canvas.height;

          const xRight = centerX + i * (barWidth + barSpacing);
          const xLeft = centerX - (i + 1) * (barWidth + barSpacing);

          ctx.beginPath();
          ctx.moveTo(xRight, canvas.height);
          ctx.lineTo(xRight, canvas.height - height);
          ctx.stroke();

          ctx.beginPath();
          ctx.moveTo(xLeft, canvas.height);
          ctx.lineTo(xLeft, canvas.height - height);
          ctx.stroke();
        }

        ctx.globalAlpha = 1;
      }
      animate();
    }

    // Исправленный обработчик playButton с muted play для мобильных
    playButton.addEventListener('click', async () => {
      playButton.classList.toggle('playing');
      buttonText.style.opacity = 0;

      try {
        if (!isInitialized) {
          if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
          }

          if (audioContext.state === "suspended") {
            await audioContext.resume();
          }

          if (!source) {
            source = audioContext.createMediaElementSource(audio);
            analyser = audioContext.createAnalyser();
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 64;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
          }

          // Запускаем сначала с muted, чтобы разблокировать воспроизведение на мобиле
          audio.muted = true;
          await audio.play();
          // Потом включаем звук
          audio.muted = false;

          draw();
          isInitialized = true;
          buttonText.textContent = "Pause";
          canvas.style.opacity = 1;
        } else {
          if (audio.paused) {
            if (audioContext.state === "suspended") {
              await audioContext.resume();
            }
            await audio.play();
            buttonText.textContent = "Pause";
            draw();
          } else {
            audio.pause();
            buttonText.textContent = "Play";
          }
        }
      } catch (err) {
        console.error("Ошибка воспроизведения:", err);
        alert("Браузер заблокировал воспроизведение. Попробуйте снова нажать Play.");
      }

      buttonText.style.opacity = 1;
    });

    audio.addEventListener('timeupdate', () => {
      if (!isSeeking) {
        const progress = (audio.currentTime / audio.duration) * 100;
        seekSlider.value = progress || 0;
      }
    });

    seekSlider.addEventListener('mousedown', () => isSeeking = true);
    seekSlider.addEventListener('mouseup', () => {
      isSeeking = false;
      audio.currentTime = (seekSlider.value / 100) * audio.duration;
    });

    audio.addEventListener('ended', () => {
      cancelAnimationFrame(animationId);
      fadeOutProgress = 0;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      buttonText.textContent = "Play";
      playButton.classList.remove('playing');
      seekSlider.value = 0;
    });

    // Кастомный курсор
    const isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

    if (isDesktop) {
      let mouseX = window.innerWidth / 2;
      let mouseY = window.innerHeight / 2;
      let cursorX = mouseX;
      let cursorY = mouseY;

      document.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (!customCursor.classList.contains('visible')) {
          customCursor.classList.add('visible');
        }
      });

      function animateCursor() {
        cursorX += (mouseX - cursorX) * 0.1;
        cursorY += (mouseY - cursorY) * 0.1;

        customCursor.style.left = cursorX + 'px';
        customCursor.style.top = cursorY + 'px';

        requestAnimationFrame(animateCursor);
      }

      animateCursor();

      document.addEventListener('mouseenter', () => {
        customCursor.classList.add('visible');
      });

      document.addEventListener('mouseleave', () => {
        customCursor.classList.remove('visible');
      });

      document.addEventListener('mousedown', () => {
        customCursor.classList.add('click');
      });

      document.addEventListener('mouseup', () => {
        customCursor.classList.remove('click');
      });

      document.querySelectorAll('a, button, input').forEach(el => {
        el.addEventListener('mouseenter', () => customCursor.classList.add('hover'));
        el.addEventListener('mouseleave', () => customCursor.classList.remove('hover'));
      });

      cursorVideo.addEventListener('timeupdate', () => {
        if (cursorVideo.currentTime >= cursorVideo.duration - 0.15) {
          cursorVideo.currentTime = 0;
        }
      });
    } else {
      customCursor.style.display = "none";
    }
  </script>
</body>
</html>
